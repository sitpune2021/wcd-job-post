import{c as $,u as z,r as c,d as D,e as B,j as e,B as d,C as F,I as y,X as T,o as V,i as Z,s as u,n as q}from"./index-f2aTh8Q9.js";import{b as H,e as O,f as U}from"./role.service-YQ4oXYS4.js";import{A as X}from"./arrow-left-D3u76-63.js";const G=[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",key:"1xq2db"}]],J=$("zap",G),K=V({role_name:u().min(2,"Role Name must be at least 2 characters"),role_code:u().min(2,"Role Code must be at least 2 characters").regex(/^[A-Z_]+$/,"Code must be uppercase with underscores (e.g., ADMIN_USER)"),description:u().optional(),permission_ids:Z(q())}),se=({initialData:i,onSubmit:_,isLoading:w,title:S})=>{const b=z(),[g,C]=c.useState([]),[A,k]=c.useState(!0),[P,I]=c.useState([]),[r,n]=c.useState([]),[m,R]=c.useState(!1),{register:x,handleSubmit:W,formState:{errors:f},watch:M,setValue:p}=D({resolver:B(K),defaultValues:{role_name:"",role_code:"",description:"",...i,permission_ids:i?.permissions?.map(s=>s.permission_id)||[]}}),h=M("permission_ids");c.useEffect(()=>{(async()=>{try{const[t,l]=await Promise.all([H(),O().catch(()=>[])]);if(C(t),I(l),i?.role_id){const a=await U(i.role_id).catch(()=>[]);n(a.map(o=>o.wildcard_pattern))}}catch(t){console.error("Failed to fetch data",t)}finally{k(!1)}})()},[i?.role_id]);const j=c.useMemo(()=>{const s={};return g.forEach(t=>{s[t.module]||(s[t.module]=[]),s[t.module].push(t)}),s},[g]),E=s=>{const t=h||[];t.includes(s)?p("permission_ids",t.filter(l=>l!==s)):p("permission_ids",[...t,s])},N=(s,t)=>{const l=j[s].map(o=>o.permission_id),a=new Set(h);t?l.forEach(o=>a.add(o)):l.forEach(o=>a.delete(o)),p("permission_ids",Array.from(a))},v=s=>{r.includes(s)?n(r.filter(t=>t!==s)):n([...r,s])},L=s=>r.includes("*")||r.includes(`${s}.*`);return e.jsxs("div",{className:"max-w-4xl mx-auto space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4 ml-[-10px]",children:[e.jsx(d,{onClick:()=>b("/roles"),variant:"ghost",leftIcon:e.jsx(X,{className:"h-5 w-5"})}),e.jsx("div",{children:e.jsx("h1",{className:"text-xl font-bold text-slate-900",children:S})})]}),e.jsx(F,{children:e.jsxs("form",{onSubmit:W(s=>_(s,r)),className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(y,{label:"Role Name",placeholder:"District Administrator",error:f.role_name?.message,...x("role_name"),disabled:i?.is_system_role}),e.jsx(y,{label:"Role Code",placeholder:"DISTRICT_ADMIN",error:f.role_code?.message,...x("role_code"),disabled:i?.is_system_role}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"Description"}),e.jsx("textarea",{...x("description"),className:"flex min-h-[80px] w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Description of the role..."})]})]}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-medium text-slate-900 flex items-center gap-2",children:[e.jsx(J,{className:"h-5 w-5 text-yellow-500"}),"Wildcard Permissions"]}),e.jsx("p",{className:"text-sm text-slate-500",children:"Assign broad access patterns instead of individual permissions"})]}),e.jsx(d,{type:"button",variant:"outline",size:"sm",onClick:()=>R(!m),children:m?"Hide":"Add Wildcard"})]}),r.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2 mb-4",children:r.map(s=>e.jsxs("span",{className:"inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800",children:[s,e.jsx("button",{type:"button",onClick:()=>v(s),className:"hover:text-yellow-900",children:e.jsx(T,{className:"h-3 w-3"})})]},s))}),m&&e.jsxs("div",{className:"bg-yellow-50 p-4 rounded-lg border border-yellow-200 mb-4",children:[e.jsx("h4",{className:"font-medium text-slate-700 mb-3",children:"Available Patterns"}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2",children:P.map(s=>e.jsxs("label",{className:`flex items-start gap-2 p-2 rounded cursor-pointer hover:bg-yellow-100 ${r.includes(s.pattern)?"bg-yellow-100":""}`,children:[e.jsx("input",{type:"checkbox",checked:r.includes(s.pattern),onChange:()=>v(s.pattern),className:"mt-1 rounded border-slate-300 text-yellow-600 focus:ring-yellow-500"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-mono font-medium text-slate-900",children:s.pattern}),e.jsx("span",{className:"text-xs text-slate-500 block",children:s.description})]})]},s.pattern))})]})]}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsx("h3",{className:"text-lg font-medium text-slate-900 mb-4",children:"Individual Permissions"}),e.jsx("p",{className:"text-sm text-slate-500 mb-4",children:"Select specific permissions. Modules covered by wildcards are highlighted."}),A?e.jsx("p",{children:"Loading permissions..."}):e.jsx("div",{className:"space-y-6",children:Object.entries(j).map(([s,t])=>{const l=L(s);return e.jsxs("div",{className:`p-4 rounded-lg border ${l?"bg-green-50 border-green-200":"bg-slate-50 border-slate-200"}`,children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("h4",{className:"font-semibold text-slate-700 capitalize",children:[s," Management"]}),l&&e.jsx("span",{className:"text-xs bg-green-200 text-green-800 px-2 py-0.5 rounded",children:"Covered by wildcard"})]}),!l&&e.jsxs("div",{className:"text-xs space-x-2",children:[e.jsx("button",{type:"button",onClick:()=>N(s,!0),className:"text-blue-600 hover:underline",children:"Select All"}),e.jsx("span",{className:"text-slate-300",children:"|"}),e.jsx("button",{type:"button",onClick:()=>N(s,!1),className:"text-slate-500 hover:underline",children:"Clear"})]})]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3",children:t.map(a=>e.jsxs("label",{className:`flex items-start gap-2 cursor-pointer ${l?"opacity-50":""}`,children:[e.jsx("input",{type:"checkbox",checked:l||h?.includes(a.permission_id),onChange:()=>!l&&E(a.permission_id),disabled:l,className:"mt-1 rounded border-slate-300 text-blue-600 focus:ring-blue-500"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium text-slate-900 block",children:a.permission_name}),e.jsx("span",{className:"text-xs text-slate-500 font-mono",children:a.permission_code})]})]},a.permission_id))})]},s)})})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t border-gray-100 mt-6",children:[e.jsx(d,{type:"button",variant:"outline",onClick:()=>b("/roles"),children:"Cancel"}),e.jsx(d,{type:"submit",isLoading:w,children:"Save Role"})]})]})})]})};export{se as R};
