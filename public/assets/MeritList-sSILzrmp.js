import{c as L,r as i,j as t,B as d,F as P,z as c}from"./index-BRObMItW.js";import{D}from"./DataTable-D6LM067x.js";import{t as M,g as C}from"./master.service-J7lkP8G3.js";import{e as A,f as T,h as I,s as G}from"./admin.service-B9TIfHn5.js";import{F as R}from"./funnel-BnL8ad68.js";import"./useDebounce-XAFs3ZYN.js";import"./triangle-alert-BV9EplDZ.js";const F=[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]],z=L("refresh-cw",F),U=()=>{const[n,p]=i.useState([]),[m,u]=i.useState([]),[g,f]=i.useState([]),[y,x]=i.useState(!1),[a,j]=i.useState(""),[l,N]=i.useState(""),[w,_]=i.useState(1),[h,v]=i.useState(20);i.useEffect(()=>{(async()=>{try{const[s,r]=await Promise.all([M({is_active:!0}),C({is_active:!0})]);u(Array.isArray(s)?s:s.posts||[]),f(Array.isArray(r)?r:r.districts||[])}catch(s){console.error("Failed to load masters",s)}})()},[]);const o=async()=>{if(a){x(!0);try{const e=await A(a,l||null);p(Array.isArray(e)?e:e.merit_list||[])}catch(e){console.error("Fetch merit list error",e)}finally{x(!1)}}};i.useEffect(()=>{a?o():p([])},[a,l]);const b=async()=>{if(!a)return c.error("Please select a post first");if(!window.confirm("This will recalculate scores for all eligible candidates. Do you want to proceed?"))return;const e=c.loading("Generating merit list...");try{await T(a,l||null),c.success("Merit list generated successfully",{id:e}),o()}catch{c.error("Failed to generate merit list",{id:e})}},E=async e=>{if(!a)return c.error("Select a post to export");try{const s=await I(a,e,l||null);c.success(`Exporting as ${e.toUpperCase()}...`)}catch{c.error("Export failed")}},k=async e=>{if(!window.confirm("Mark this candidate as SELECTED? This will auto-reject their other applications."))return;const s=c.loading("Selecting candidate...");try{const r=await G(e);c.success(`Selected! ${r?.autoRejectedCount||0} other applications auto-rejected.`,{id:s}),o()}catch(r){c.error(r.message||"Selection failed",{id:s})}},S=[{key:"rank",header:"Rank",width:"60px"},{key:"application_no",header:"App No",render:e=>e.application?.application_no},{key:"applicant_name",header:"Applicant Name",render:e=>e.application?.applicant?.personal?.full_name},{key:"is_local",header:"Local",width:"60px",render:e=>e.is_local_candidate?t.jsx("span",{className:"text-green-600 font-medium",children:"Yes"}):t.jsx("span",{className:"text-slate-400",children:"No"})},{key:"education_score",header:"Edu",width:"60px",render:e=>t.jsx("span",{className:"text-xs",children:e.education_score||0})},{key:"marks_score",header:"Marks",width:"60px",render:e=>t.jsx("span",{className:"text-xs",children:e.marks_score||0})},{key:"experience_score",header:"Exp",width:"60px",render:e=>t.jsx("span",{className:"text-xs",children:e.experience_score||0})},{key:"age_score",header:"Age",width:"60px",render:e=>t.jsx("span",{className:"text-xs",children:e.age_score||0})},{key:"local_preference_score",header:"Local",width:"60px",render:e=>t.jsx("span",{className:"text-xs",children:e.local_preference_score||0})},{key:"score",header:"Total",width:"70px",render:e=>t.jsx("span",{className:"font-bold text-blue-600",children:e.score})},{key:"status",header:"Status",width:"100px",render:e=>{const s=e.selection_status||"PENDING",r={PENDING:"bg-slate-100 text-slate-600",SELECTED:"bg-green-100 text-green-700",REJECTED:"bg-red-100 text-red-700",SELECTED_IN_OTHER_POST:"bg-yellow-100 text-yellow-700"};return t.jsx("span",{className:`px-2 py-1 rounded text-xs ${r[s]||r.PENDING}`,children:s})}},{key:"actions",header:"Actions",width:"100px",render:e=>e.selection_status==="PENDING"?t.jsx(d,{size:"sm",variant:"primary",onClick:()=>k(e.application_id),children:"Select"}):null}];return t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4",children:[t.jsxs("div",{children:[t.jsx("h1",{className:"text-2xl font-bold text-slate-900",children:"Merit List"}),t.jsx("p",{className:"text-sm text-slate-500 mt-1",children:"Generate and view merit lists"})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(d,{variant:"primary",onClick:b,disabled:!a,leftIcon:t.jsx(z,{className:"h-4 w-4"}),children:"Generate List"}),t.jsx(d,{variant:"outline",onClick:()=>E("excel"),disabled:!a||n.length===0,leftIcon:t.jsx(P,{className:"h-4 w-4"}),children:"Export Excel"})]})]}),t.jsx("div",{className:"bg-white p-4 rounded-lg shadow border",children:t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 items-end",children:[t.jsxs("div",{children:[t.jsxs("label",{className:"block text-sm font-medium mb-1",children:["Post ",t.jsx("span",{className:"text-red-500",children:"*"})]}),t.jsxs("select",{value:a,onChange:e=>j(e.target.value),className:"w-full rounded-md border px-3 py-2 text-sm",children:[t.jsx("option",{value:"",children:"Select Post"}),m.map(e=>t.jsx("option",{value:e.post_id,children:e.post_name},e.post_id))]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"District (Optional)"}),t.jsxs("select",{value:l,onChange:e=>N(e.target.value),className:"w-full rounded-md border px-3 py-2 text-sm",children:[t.jsx("option",{value:"",children:"All Districts"}),g.map(e=>t.jsx("option",{value:e.district_id,children:e.district_name},e.district_id))]})]}),t.jsx("div",{})]})}),a?t.jsx(D,{columns:S,data:n,pagination:{currentPage:w,totalPages:Math.ceil(n.length/h)||1,onPageChange:_,pageSize:h,onPageSizeChange:v},isLoading:y,rowKey:"merit_id"}):t.jsxs("div",{className:"text-center py-10 bg-slate-50 border border-dashed rounded-lg",children:[t.jsx(R,{className:"h-10 w-10 text-slate-300 mx-auto mb-2"}),t.jsx("p",{className:"text-slate-500",children:"Please select a post to view the merit list"})]})]})};export{U as default};
